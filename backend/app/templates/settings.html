{% extends "base.html" %}

{% block content %}
<div class="bg-slate-900 min-h-full pb-12">
    <div class="bg-slate-800/50 border-b border-slate-800">
        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <h1 class="text-3xl font-bold text-white tracking-tight">Settings</h1>
            <p class="text-slate-400 mt-2">Personalize Walkabout to show deals relevant to you</p>
        </div>
    </div>

    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
        <form id="settings-form" class="space-y-8">
            
            <!-- Home Airport Section -->
            <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
                <div class="flex items-start gap-4 mb-6">
                    <div class="w-10 h-10 rounded-lg bg-cyan-500/10 flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-white">Your Home Airport</h2>
                        <p class="text-sm text-slate-400 mt-1">Deals departing from here will be highlighted as most relevant to you</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="home_airport" class="block text-sm font-medium text-slate-300 mb-2">
                            Airport
                        </label>
                        <div class="relative">
                            <input type="text" id="home_airport" name="home_airport" 
                                   value="{{ settings.home_airport }}"
                                   autocomplete="off"
                                   class="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-lg text-white 
                                          placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-500 
                                          focus:border-transparent uppercase font-mono text-lg tracking-wider"
                                   placeholder="Type city or code...">
                            <div id="airport-dropdown" class="hidden absolute z-10 w-full mt-1 bg-slate-800 border border-slate-600 rounded-lg shadow-xl max-h-60 overflow-y-auto"></div>
                        </div>
                        <p id="airport-hint" class="mt-2 text-xs text-slate-500">Start typing a city name or airport code</p>
                    </div>
                    
                    <div>
                        <label for="home_region" class="block text-sm font-medium text-slate-300 mb-2">
                            Region
                        </label>
                        <select id="home_region" name="home_region"
                                class="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-lg text-white 
                                       focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                            <option value="Oceania" {% if settings.home_region == 'Oceania' %}selected{% endif %}>Oceania (NZ/AU/Pacific)</option>
                            <option value="North America" {% if settings.home_region == 'North America' %}selected{% endif %}>North America</option>
                            <option value="Europe" {% if settings.home_region == 'Europe' %}selected{% endif %}>Europe</option>
                            <option value="Asia" {% if settings.home_region == 'Asia' %}selected{% endif %}>Asia</option>
                            <option value="South America" {% if settings.home_region == 'South America' %}selected{% endif %}>South America</option>
                            <option value="Africa" {% if settings.home_region == 'Africa' %}selected{% endif %}>Africa</option>
                        </select>
                        <p class="mt-2 text-xs text-slate-500">Deals from nearby airports in your region are also highlighted</p>
                    </div>
                </div>
            </div>

            <!-- Watched Destinations Section -->
            <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
                <div class="flex items-start gap-4 mb-6">
                    <div class="w-10 h-10 rounded-lg bg-violet-500/10 flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 text-violet-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-white">Dream Destinations</h2>
                        <p class="text-sm text-slate-400 mt-1">Add places you'd love to visit â€” we'll flag deals to these destinations and similar alternatives</p>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">
                            Destinations
                        </label>
                        <input type="hidden" id="watched_destinations" name="watched_destinations" 
                               value="{{ settings.watched_destinations | join(',') }}">
                        
                        <div class="relative group">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-slate-500 group-focus-within:text-cyan-400 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </div>
                            <input type="text" id="destination_search" 
                                   class="w-full pl-11 pr-4 py-3 bg-slate-900 border border-slate-600 rounded-lg text-white 
                                          placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-500 
                                          focus:border-transparent font-sans transition-all"
                                   placeholder="Search by city or airport (e.g. Tokyo, Fiji)..."
                                   autocomplete="off">
                            <div id="destination-dropdown" class="hidden absolute z-20 w-full mt-2 bg-slate-800 border border-slate-600 rounded-lg shadow-xl shadow-black/50 max-h-60 overflow-y-auto overflow-x-hidden"></div>
                        </div>

                        <div id="destinations-container" class="flex flex-wrap gap-2 mt-4 min-h-[32px]">
                        </div>
                        <p class="mt-2 text-xs text-slate-500">
                            Search and add as many destinations as you like.
                        </p>
                    </div>
                            <input type="text" id="destination_search" 
                                   class="w-full pl-11 pr-4 py-3 bg-slate-900 border border-slate-600 rounded-lg text-white 
                                          placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-500 
                                          focus:border-transparent font-sans transition-all"
                                   placeholder="Search by city or airport (e.g. Tokyo, Fiji)..."
                                   autocomplete="off">
                            <div id="destination-dropdown" class="hidden absolute z-20 w-full mt-2 bg-slate-800 border border-slate-600 rounded-lg shadow-xl shadow-black/50 max-h-60 overflow-y-auto overflow-x-hidden"></div>
                        </div>

                        <!-- Selected Chips -->
                        <div id="destinations-container" class="flex flex-wrap gap-2 mt-4 min-h-[32px]">
                            <!-- Chips injected via JS -->
                        </div>
                        <p class="mt-2 text-xs text-slate-500">
                            Search and add as many destinations as you like.
                        </p>
                    </div>
                    
                    <div class="bg-slate-900/50 rounded-lg p-4 border border-slate-700/50">
                        <p class="text-sm text-slate-400">
                            <span class="text-violet-400 font-medium">ðŸ’¡ Smart matching:</span> 
                            If you add "NAN" (Fiji), we'll also show deals to similar destinations like Rarotonga, Samoa, and Tahiti.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Currency Section -->
            <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
                <div class="flex items-start gap-4 mb-6">
                    <div class="w-10 h-10 rounded-lg bg-emerald-500/10 flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-white">Currency Preference</h2>
                        <p class="text-sm text-slate-400 mt-1">See prices converted to your preferred currency</p>
                    </div>
                </div>
                
                <div>
                    <label for="preferred_currency" class="block text-sm font-medium text-slate-300 mb-2">
                        Display Currency
                    </label>
                    <select id="preferred_currency" name="preferred_currency"
                            class="w-full max-w-xs px-4 py-3 bg-slate-900 border border-slate-600 rounded-lg text-white 
                                   focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                        <option value="NZD" {% if (settings.preferred_currency or 'NZD') == 'NZD' %}selected{% endif %}>ðŸ‡³ðŸ‡¿ NZD - New Zealand Dollar</option>
                        <option value="AUD" {% if settings.preferred_currency == 'AUD' %}selected{% endif %}>ðŸ‡¦ðŸ‡º AUD - Australian Dollar</option>
                        <option value="USD" {% if settings.preferred_currency == 'USD' %}selected{% endif %}>ðŸ‡ºðŸ‡¸ USD - US Dollar</option>
                        <option value="EUR" {% if settings.preferred_currency == 'EUR' %}selected{% endif %}>ðŸ‡ªðŸ‡º EUR - Euro</option>
                        <option value="GBP" {% if settings.preferred_currency == 'GBP' %}selected{% endif %}>ðŸ‡¬ðŸ‡§ GBP - British Pound</option>
                        <option value="SGD" {% if settings.preferred_currency == 'SGD' %}selected{% endif %}>ðŸ‡¸ðŸ‡¬ SGD - Singapore Dollar</option>
                        <option value="JPY" {% if settings.preferred_currency == 'JPY' %}selected{% endif %}>ðŸ‡¯ðŸ‡µ JPY - Japanese Yen</option>
                        <option value="CAD" {% if settings.preferred_currency == 'CAD' %}selected{% endif %}>ðŸ‡¨ðŸ‡¦ CAD - Canadian Dollar</option>
                    </select>
                    <p class="mt-2 text-xs text-slate-500">Original price is always shown alongside the conversion</p>
                </div>
            </div>

            <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
                <div class="flex items-start gap-4 mb-6">
                    <div class="w-10 h-10 rounded-lg bg-orange-500/10 flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 text-orange-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-white">API Keys (Optional)</h2>
                        <p class="text-sm text-slate-400 mt-1">Add API keys for better price tracking. Without keys, we'll use browser scraping as fallback.</p>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div class="bg-slate-900/50 rounded-lg p-4 border border-slate-700/50 mb-4">
                        <p class="text-sm text-slate-400">
                            <span class="text-cyan-400 font-medium">How it works:</span> 
                            Price tracking tries API sources first (faster, more reliable), then falls back to browser scraping.
                            AI analysis requires an Anthropic API key.
                        </p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">
                            Anthropic API Key <span class="text-violet-400">(enables AI recommendations)</span>
                        </label>
                        <input type="password" id="anthropic_api_key" name="anthropic_api_key" 
                               value="{{ settings.anthropic_api_key or '' }}"
                               class="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-lg text-white 
                                      placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-500 
                                      focus:border-transparent font-mono text-sm"
                               placeholder="sk-ant-...">
                        <p class="mt-1 text-xs text-slate-500">Get from <a href="https://console.anthropic.com/" target="_blank" class="text-cyan-400 hover:underline">console.anthropic.com</a></p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">
                            SerpAPI Key <span class="text-emerald-400">(Google Flights data)</span>
                        </label>
                        <input type="password" id="serpapi_key" name="serpapi_key" 
                               value="{{ settings.serpapi_key or '' }}"
                               class="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-lg text-white 
                                      placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-500 
                                      focus:border-transparent font-mono text-sm"
                               placeholder="your-serpapi-key">
                        <p class="mt-1 text-xs text-slate-500">Get from <a href="https://serpapi.com/" target="_blank" class="text-cyan-400 hover:underline">serpapi.com</a> - 100 free searches/month</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">
                            Skyscanner RapidAPI Key
                        </label>
                        <input type="password" id="skyscanner_api_key" name="skyscanner_api_key" 
                               value="{{ settings.skyscanner_api_key or '' }}"
                               class="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-lg text-white 
                                      placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-500 
                                      focus:border-transparent font-mono text-sm"
                               placeholder="your-rapidapi-key">
                        <p class="mt-1 text-xs text-slate-500">Get from <a href="https://rapidapi.com/apiheya/api/sky-scanner3" target="_blank" class="text-cyan-400 hover:underline">RapidAPI</a> - free tier available</p>
                    </div>
                </div>
            </div>

            <div class="bg-slate-800 rounded-xl p-6 border border-slate-700 opacity-60">
                <div class="flex items-start gap-4 mb-6">
                    <div class="w-10 h-10 rounded-lg bg-amber-500/10 flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-white">Notifications</h2>
                        <p class="text-sm text-slate-400 mt-1">Coming soon â€” get push alerts for hot deals</p>
                    </div>
                </div>
                
                <div class="flex items-center justify-between">
                    <div>
                        <span class="text-sm font-medium text-slate-400">Push Notifications</span>
                        <p class="text-xs text-slate-600">Not yet implemented</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-not-allowed">
                        <input type="checkbox" id="notifications_enabled" name="notifications_enabled" disabled
                               {% if settings.notifications_enabled %}checked{% endif %}
                               class="sr-only peer">
                        <div class="w-11 h-6 bg-slate-700 rounded-full peer peer-checked:bg-slate-600
                                    after:content-[''] after:absolute after:top-[2px] after:left-[2px] 
                                    after:bg-slate-500 after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                    </label>
                </div>
            </div>

            <!-- Save Button -->
            <div class="flex items-center justify-between pt-4">
                <a href="/deals/" class="text-slate-400 hover:text-white transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                    Back to Deals
                </a>
                <button type="submit" 
                        class="px-8 py-3 bg-cyan-500 hover:bg-cyan-400 text-white font-semibold rounded-lg 
                               shadow-lg shadow-cyan-500/25 transition-all flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    Save Settings
                </button>
            </div>
        </form>
        
        <div id="save-status" class="hidden mt-6 p-4 rounded-lg text-center"></div>
    </div>
</div>

<script>
// Airport search autocomplete
const airportInput = document.getElementById('home_airport');
const dropdown = document.getElementById('airport-dropdown');
const hint = document.getElementById('airport-hint');
let debounceTimer;

airportInput.addEventListener('input', (e) => {
    clearTimeout(debounceTimer);
    const query = e.target.value.trim();
    
    if (query.length < 2) {
        dropdown.classList.add('hidden');
        hint.textContent = 'Start typing a city name or airport code';
        return;
    }
    
    debounceTimer = setTimeout(async () => {
        try {
            const response = await fetch(`/settings/api/airports/search?q=${encodeURIComponent(query)}&limit=8`);
            const data = await response.json();
            
            if (data.results && data.results.length > 0) {
                dropdown.innerHTML = data.results.map(a => `
                    <button type="button" 
                            class="w-full px-4 py-3 text-left hover:bg-slate-700 flex items-center gap-3 border-b border-slate-700 last:border-0"
                            onclick="selectAirport('${a.code}', '${a.city}', '${a.country}')">
                        <span class="font-mono font-bold text-cyan-400">${a.code}</span>
                        <span class="text-slate-300">${a.city}, ${a.country}</span>
                    </button>
                `).join('');
                dropdown.classList.remove('hidden');
            } else {
                dropdown.classList.add('hidden');
            }
        } catch (err) {
            console.error('Airport search failed:', err);
        }
    }, 200);
});

function selectAirport(code, city, country) {
    airportInput.value = code;
    dropdown.classList.add('hidden');
    hint.innerHTML = `<span class="text-cyan-400">${city}, ${country}</span>`;
}

// Close dropdown when clicking outside
document.addEventListener('click', (e) => {
    if (!airportInput.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.classList.add('hidden');
    }
    if (!destInput.contains(e.target) && !destDropdown.contains(e.target)) {
        destDropdown.classList.add('hidden');
    }
});

const destInput = document.getElementById('destination_search');
const destDropdown = document.getElementById('destination-dropdown');
const destContainer = document.getElementById('destinations-container');
const destHidden = document.getElementById('watched_destinations');

const airportNames = {
    'SYD': 'Sydney', 'MEL': 'Melbourne', 'AKL': 'Auckland', 'CHC': 'Christchurch',
    'NAN': 'Nadi', 'HNL': 'Honolulu', 'SIN': 'Singapore', 'BNE': 'Brisbane',
    'TYO': 'Tokyo', 'NRT': 'Tokyo Narita', 'HND': 'Tokyo Haneda',
    'LHR': 'London Heathrow', 'LGW': 'London Gatwick', 'LAX': 'Los Angeles',
    'JFK': 'New York JFK', 'DXB': 'Dubai', 'BKK': 'Bangkok', 'DPS': 'Bali',
    'RAR': 'Rarotonga', 'WLG': 'Wellington', 'ZQN': 'Queenstown'
};

let selectedDestinations = destHidden.value
    .split(',')
    .map(s => s.trim())
    .filter(s => s)
    .map(code => ({
        code: code,
        name: airportNames[code] || code 
    }));

renderDestinations();

let destDebounceTimer;

destInput.addEventListener('input', (e) => {
    clearTimeout(destDebounceTimer);
    const query = e.target.value.trim();
    
    if (query.length < 2) {
        destDropdown.classList.add('hidden');
        return;
    }
    
    destDebounceTimer = setTimeout(async () => {
        try {
            const response = await fetch(`/settings/api/airports/search?q=${encodeURIComponent(query)}&limit=8`);
            const data = await response.json();
            
            if (data.results && data.results.length > 0) {
                const available = data.results.filter(r => !selectedDestinations.find(s => s.code === r.code));
                
                if (available.length === 0) {
                    destDropdown.innerHTML = `<div class="px-4 py-3 text-sm text-slate-500 italic">Already added</div>`;
                } else {
                    destDropdown.innerHTML = available.map(a => `
                        <button type="button" 
                                class="w-full px-4 py-3 text-left hover:bg-slate-700 flex items-center justify-between group transition-colors border-b border-slate-700/50 last:border-0"
                                onclick="addDestination('${a.code}', '${a.city}', '${a.country}')">
                            <div class="flex flex-col">
                                <span class="font-bold text-white group-hover:text-cyan-400 transition-colors">${a.city}</span>
                                <span class="text-xs text-slate-400">${a.country}</span>
                            </div>
                            <span class="font-mono text-sm font-bold text-slate-500 group-hover:text-white bg-slate-900 px-2 py-1 rounded">${a.code}</span>
                        </button>
                    `).join('');
                }
                destDropdown.classList.remove('hidden');
            } else {
                destDropdown.innerHTML = `<div class="px-4 py-3 text-sm text-slate-500">No results found</div>`;
                destDropdown.classList.remove('hidden');
            }
        } catch (err) {
            console.error('Search failed:', err);
        }
    }, 200);
});

function addDestination(code, city, country) {
    if (selectedDestinations.some(d => d.code === code)) return;
    
    selectedDestinations.push({
        code: code,
        name: city
    });
    
    updateDestinations();
    destInput.value = '';
    destInput.focus();
    destDropdown.classList.add('hidden');
}

function removeDestination(code) {
    selectedDestinations = selectedDestinations.filter(d => d.code !== code);
    updateDestinations();
}

function updateDestinations() {
    destHidden.value = selectedDestinations.map(d => d.code).join(',');
    renderDestinations();
}

function renderDestinations() {
    destContainer.innerHTML = selectedDestinations.map(dest => `
        <div class="inline-flex items-center pl-3 pr-2 py-1.5 rounded-lg bg-slate-800 border border-slate-700 group hover:border-cyan-500/50 transition-all shadow-sm">
            <span class="text-sm font-medium text-slate-200 mr-2">
                <span class="font-mono text-cyan-400 font-bold mr-1.5">${dest.code}</span>
                ${dest.name !== dest.code ? `<span class="text-slate-400 border-l border-slate-700 pl-1.5">${dest.name}</span>` : ''}
            </span>
            <button type="button" 
                    onclick="removeDestination('${dest.code}')"
                    class="p-1 rounded-md text-slate-500 hover:text-red-400 hover:bg-slate-700/50 transition-colors"
                    aria-label="Remove ${dest.code}">
                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    `).join('');
}

// --- Destination Tags Implementation ---
const destInput = document.getElementById('destination_search');
const destDropdown = document.getElementById('destination-dropdown');
const destContainer = document.getElementById('destinations-container');
const destHidden = document.getElementById('watched_destinations');

// Common mappings for nicer initial display
const airportNames = {
    'SYD': 'Sydney', 'MEL': 'Melbourne', 'AKL': 'Auckland', 'CHC': 'Christchurch',
    'NAN': 'Nadi', 'HNL': 'Honolulu', 'SIN': 'Singapore', 'BNE': 'Brisbane',
    'TYO': 'Tokyo', 'NRT': 'Tokyo Narita', 'HND': 'Tokyo Haneda',
    'LHR': 'London Heathrow', 'LGW': 'London Gatwick', 'LAX': 'Los Angeles',
    'JFK': 'New York JFK', 'DXB': 'Dubai', 'BKK': 'Bangkok', 'DPS': 'Bali',
    'RAR': 'Rarotonga', 'WLG': 'Wellington', 'ZQN': 'Queenstown'
};

// Initialize state from hidden input
let selectedDestinations = destHidden.value
    .split(',')
    .map(s => s.trim())
    .filter(s => s)
    .map(code => ({
        code: code,
        name: airportNames[code] || code // Use name if known, else code
    }));

// Render initial chips
renderDestinations();

let destDebounceTimer;

destInput.addEventListener('input', (e) => {
    clearTimeout(destDebounceTimer);
    const query = e.target.value.trim();
    
    if (query.length < 2) {
        destDropdown.classList.add('hidden');
        return;
    }
    
    destDebounceTimer = setTimeout(async () => {
        try {
            const response = await fetch(`/settings/api/airports/search?q=${encodeURIComponent(query)}&limit=8`);
            const data = await response.json();
            
            if (data.results && data.results.length > 0) {
                // Filter out already selected
                const available = data.results.filter(r => !selectedDestinations.find(s => s.code === r.code));
                
                if (available.length === 0) {
                    destDropdown.innerHTML = `<div class="px-4 py-3 text-sm text-slate-500 italic">Already added</div>`;
                } else {
                    destDropdown.innerHTML = available.map(a => `
                        <button type="button" 
                                class="w-full px-4 py-3 text-left hover:bg-slate-700 flex items-center justify-between group transition-colors border-b border-slate-700/50 last:border-0"
                                onclick="addDestination('${a.code}', '${a.city}', '${a.country}')">
                            <div class="flex flex-col">
                                <span class="font-bold text-white group-hover:text-cyan-400 transition-colors">${a.city}</span>
                                <span class="text-xs text-slate-400">${a.country}</span>
                            </div>
                            <span class="font-mono text-sm font-bold text-slate-500 group-hover:text-white bg-slate-900 px-2 py-1 rounded">${a.code}</span>
                        </button>
                    `).join('');
                }
                destDropdown.classList.remove('hidden');
            } else {
                destDropdown.innerHTML = `<div class="px-4 py-3 text-sm text-slate-500">No results found</div>`;
                destDropdown.classList.remove('hidden');
            }
        } catch (err) {
            console.error('Search failed:', err);
        }
    }, 200);
});

function addDestination(code, city, country) {
    // Avoid duplicates
    if (selectedDestinations.some(d => d.code === code)) return;
    
    selectedDestinations.push({
        code: code,
        name: city
    });
    
    updateDestinations();
    destInput.value = '';
    destInput.focus();
    destDropdown.classList.add('hidden');
}

function removeDestination(code) {
    selectedDestinations = selectedDestinations.filter(d => d.code !== code);
    updateDestinations();
}

function updateDestinations() {
    // Update hidden input
    destHidden.value = selectedDestinations.map(d => d.code).join(',');
    renderDestinations();
}

function renderDestinations() {
    destContainer.innerHTML = selectedDestinations.map(dest => `
        <div class="inline-flex items-center pl-3 pr-2 py-1.5 rounded-lg bg-slate-800 border border-slate-700 group hover:border-cyan-500/50 transition-all shadow-sm">
            <span class="text-sm font-medium text-slate-200 mr-2">
                <span class="font-mono text-cyan-400 font-bold mr-1.5">${dest.code}</span>
                ${dest.name !== dest.code ? `<span class="text-slate-400 border-l border-slate-700 pl-1.5">${dest.name}</span>` : ''}
            </span>
            <button type="button" 
                    onclick="removeDestination('${dest.code}')"
                    class="p-1 rounded-md text-slate-500 hover:text-red-400 hover:bg-slate-700/50 transition-colors"
                    aria-label="Remove ${dest.code}">
                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    `).join('');
}

// Form submission
document.getElementById('settings-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const form = e.target;
    const statusEl = document.getElementById('save-status');
    const submitBtn = form.querySelector('button[type="submit"]');
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Saving...';
    
    const watchedDests = form.watched_destinations.value
        .split(',')
        .map(s => s.trim().toUpperCase())
        .filter(s => s.length > 0);
    
    const data = {
        home_airport: form.home_airport.value.toUpperCase().trim(),
        home_region: form.home_region.value,
        watched_destinations: watchedDests,
        preferred_currency: form.preferred_currency.value,
        anthropic_api_key: form.anthropic_api_key.value,
        serpapi_key: form.serpapi_key.value,
        skyscanner_api_key: form.skyscanner_api_key.value,
    };
    
    try {
        const response = await fetch('/settings/api/settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        });
        
        if (response.ok) {
            statusEl.className = 'mt-6 p-4 rounded-lg text-center bg-emerald-500/10 text-emerald-400 border border-emerald-500/20';
            statusEl.textContent = 'âœ“ Settings saved! Your deal feed has been updated.';
            statusEl.classList.remove('hidden');
            setTimeout(() => statusEl.classList.add('hidden'), 4000);
        } else {
            throw new Error('Failed to save');
        }
    } catch (err) {
        statusEl.className = 'mt-6 p-4 rounded-lg text-center bg-red-500/10 text-red-400 border border-red-500/20';
        statusEl.textContent = 'âœ— Failed to save settings. Please try again.';
        statusEl.classList.remove('hidden');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> Save Settings';
    }
});
</script>
{% endblock %}
