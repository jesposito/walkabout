{% extends "base.html" %}

{% block content %}
<div class="bg-slate-100 dark:bg-slate-900 min-h-full pb-12">
    <div class="bg-white/50 dark:bg-slate-800/50 border-b border-slate-200 dark:border-slate-800">
        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-slate-900 dark:text-white tracking-tight">Settings</h1>
                    <p class="text-slate-600 dark:text-slate-400 text-sm mt-1">Personalize your deal feed</p>
                </div>
                <a href="/about/" class="text-xs font-mono text-slate-500 hover:text-cyan-500 transition-colors flex items-center gap-1.5">
                    <span class="hidden sm:inline">Version</span> {{ version }}
                    <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                    </svg>
                </a>
            </div>
        </div>
    </div>

    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
        <form id="settings-form" class="space-y-4">

            <!-- Home & Destinations (Collapsible) -->
            <details class="group bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm" open>
                <summary class="flex items-center justify-between p-4 cursor-pointer select-none hover:bg-slate-50 dark:hover:bg-slate-700/50 rounded-xl transition-colors">
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-lg bg-cyan-500/10 flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </div>
                        <div>
                            <h2 class="font-semibold text-slate-900 dark:text-white">Location & Destinations</h2>
                            <p class="text-xs text-slate-500 dark:text-slate-400">Home airports and dream destinations</p>
                        </div>
                    </div>
                    <svg class="w-5 h-5 text-slate-400 group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </summary>
                <div class="px-4 pb-4 pt-2 space-y-5 border-t border-slate-200 dark:border-slate-700">
                    <!-- Home Airports -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Home Airports</label>
                        <input type="hidden" id="home_airports" name="home_airports" value="{{ settings.home_airports | join(',') if settings.home_airports else settings.home_airport }}">
                        <input type="hidden" id="home_airport" name="home_airport" value="{{ settings.home_airport }}">
                        <div class="relative">
                            <input type="text" id="home_airport_search"
                                   class="w-full pl-10 pr-4 py-2.5 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white
                                          placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent text-sm uppercase placeholder:normal-case"
                                   placeholder="Search airports..."
                                   autocomplete="off">
                            <svg class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                            <div id="home-airport-dropdown" class="hidden absolute z-20 w-full mt-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg shadow-xl max-h-48 overflow-y-auto"></div>
                        </div>
                        <div id="home-airports-container" class="flex flex-wrap gap-2 mt-3 min-h-[32px]"></div>
                    </div>

                    <!-- Region -->
                    <div>
                        <label for="home_region" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Region</label>
                        <select id="home_region" name="home_region"
                                class="w-full px-3 py-2.5 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500">
                            <option value="Oceania" {% if settings.home_region == 'Oceania' %}selected{% endif %}>Oceania (NZ/AU/Pacific)</option>
                            <option value="North America" {% if settings.home_region == 'North America' %}selected{% endif %}>North America</option>
                            <option value="Europe" {% if settings.home_region == 'Europe' %}selected{% endif %}>Europe</option>
                            <option value="Asia" {% if settings.home_region == 'Asia' %}selected{% endif %}>Asia</option>
                            <option value="South America" {% if settings.home_region == 'South America' %}selected{% endif %}>South America</option>
                            <option value="Africa" {% if settings.home_region == 'Africa' %}selected{% endif %}>Africa</option>
                        </select>
                    </div>

                    <!-- Dream Destinations -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Dream Destinations</label>
                        <input type="hidden" id="watched_destinations" name="watched_destinations" value="{{ settings.watched_destinations | join(',') }}">
                        <div class="relative">
                            <input type="text" id="destination_search"
                                   class="w-full pl-10 pr-4 py-2.5 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white
                                          placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent text-sm"
                                   placeholder="Search destinations..."
                                   autocomplete="off">
                            <svg class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                            <div id="destination-dropdown" class="hidden absolute z-20 w-full mt-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg shadow-xl max-h-48 overflow-y-auto"></div>
                        </div>
                        <div id="destinations-container" class="flex flex-wrap gap-2 mt-3 min-h-[32px]"></div>
                    </div>

                    <!-- Currency -->
                    <div>
                        <label for="preferred_currency" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Display Currency</label>
                        <select id="preferred_currency" name="preferred_currency"
                                class="w-full sm:w-48 px-3 py-2.5 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500">
                            <option value="NZD" {% if (settings.preferred_currency or 'NZD') == 'NZD' %}selected{% endif %}>NZD</option>
                            <option value="AUD" {% if settings.preferred_currency == 'AUD' %}selected{% endif %}>AUD</option>
                            <option value="USD" {% if settings.preferred_currency == 'USD' %}selected{% endif %}>USD</option>
                            <option value="EUR" {% if settings.preferred_currency == 'EUR' %}selected{% endif %}>EUR</option>
                            <option value="GBP" {% if settings.preferred_currency == 'GBP' %}selected{% endif %}>GBP</option>
                            <option value="SGD" {% if settings.preferred_currency == 'SGD' %}selected{% endif %}>SGD</option>
                            <option value="JPY" {% if settings.preferred_currency == 'JPY' %}selected{% endif %}>JPY</option>
                            <option value="CAD" {% if settings.preferred_currency == 'CAD' %}selected{% endif %}>CAD</option>
                        </select>
                    </div>
                </div>
            </details>

            <!-- Notifications (Collapsible) -->
            <details class="group bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                <summary class="flex items-center justify-between p-4 cursor-pointer select-none hover:bg-slate-50 dark:hover:bg-slate-700/50 rounded-xl transition-colors">
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-lg bg-amber-500/10 flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                            </svg>
                        </div>
                        <div>
                            <h2 class="font-semibold text-slate-900 dark:text-white">Notifications</h2>
                            <p class="text-xs text-slate-500 dark:text-slate-400">Push alerts for deals</p>
                        </div>
                    </div>
                    <svg class="w-5 h-5 text-slate-400 group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </summary>
                <div class="px-4 pb-4 pt-2 space-y-5 border-t border-slate-200 dark:border-slate-700">
                    <!-- Master Toggle -->
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="text-sm font-medium text-slate-900 dark:text-white">Push Notifications</span>
                            <p class="text-xs text-slate-500">Enable to receive alerts</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="notifications_enabled" name="notifications_enabled"
                                   {% if settings.notifications_enabled %}checked{% endif %}
                                   class="sr-only peer">
                            <div class="w-11 h-6 bg-slate-300 dark:bg-slate-700 rounded-full peer
                                        peer-checked:bg-amber-500 peer-focus:ring-2 peer-focus:ring-amber-300
                                        after:content-[''] after:absolute after:top-[2px] after:left-[2px]
                                        after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all
                                        peer-checked:after:translate-x-full"></div>
                        </label>
                    </div>

                    <!-- Provider -->
                    <div>
                        <label for="notification_provider" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Method</label>
                        <select id="notification_provider" name="notification_provider" onchange="toggleNotificationFields()"
                                class="w-full px-3 py-2.5 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-amber-500">
                            <option value="none" {% if not settings.notification_provider or settings.notification_provider == 'none' %}selected{% endif %}>None (in-app only)</option>
                            <option value="ntfy_sh" {% if settings.notification_provider == 'ntfy_sh' %}selected{% endif %}>ntfy.sh (free)</option>
                            <option value="ntfy_self" {% if settings.notification_provider == 'ntfy_self' %}selected{% endif %}>ntfy (self-hosted)</option>
                            <option value="discord" {% if settings.notification_provider == 'discord' %}selected{% endif %}>Discord Webhook</option>
                        </select>
                    </div>

                    <!-- Provider-specific fields -->
                    <div id="ntfy_sh_fields" class="hidden space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">ntfy.sh Topic</label>
                            <input type="text" id="notification_ntfy_topic_sh" name="notification_ntfy_topic"
                                   value="{{ settings.notification_ntfy_topic or '' }}"
                                   class="w-full px-3 py-2.5 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-amber-500"
                                   placeholder="walkabout-deals-xyz">
                        </div>
                    </div>

                    <div id="ntfy_self_fields" class="hidden space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Server URL</label>
                            <input type="text" id="notification_ntfy_url" name="notification_ntfy_url"
                                   value="{{ settings.notification_ntfy_url or '' }}"
                                   class="w-full px-3 py-2.5 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm font-mono focus:outline-none focus:ring-2 focus:ring-amber-500"
                                   placeholder="http://your-server:8080">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Topic</label>
                            <input type="text" id="notification_ntfy_topic_self" name="notification_ntfy_topic"
                                   value="{{ settings.notification_ntfy_topic or '' }}"
                                   class="w-full px-3 py-2.5 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-amber-500"
                                   placeholder="walkabout-deals">
                        </div>
                    </div>

                    <div id="discord_fields" class="hidden">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Webhook URL</label>
                        <input type="password" id="notification_discord_webhook" name="notification_discord_webhook"
                               value="{{ settings.notification_discord_webhook or '' }}"
                               class="w-full px-3 py-2.5 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm font-mono focus:outline-none focus:ring-2 focus:ring-amber-500"
                               placeholder="https://discord.com/api/webhooks/...">
                    </div>

                    <!-- Test Button -->
                    <div class="flex items-center gap-3">
                        <button type="button" id="test-notification-btn"
                                class="px-3 py-2 bg-amber-500/10 hover:bg-amber-500/20 text-amber-600 dark:text-amber-400 text-sm font-medium rounded-lg border border-amber-500/20 transition-colors">
                            Send Test
                        </button>
                        <span id="test-notification-status" class="text-sm text-slate-500"></span>
                    </div>

                    <!-- Notification Types -->
                    <div class="border-t border-slate-200 dark:border-slate-700 pt-4 space-y-3">
                        <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">Notification Types</p>

                        <div class="flex items-center justify-between py-1">
                            <span class="text-sm text-slate-700 dark:text-slate-300">Deal Alerts</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="notify_deals" name="notify_deals"
                                       {% if settings.notify_deals is none or settings.notify_deals %}checked{% endif %}
                                       class="sr-only peer">
                                <div class="w-9 h-5 bg-slate-300 dark:bg-slate-700 rounded-full peer peer-checked:bg-amber-500 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-4"></div>
                            </label>
                        </div>

                        <div class="flex items-center justify-between py-1">
                            <span class="text-sm text-slate-700 dark:text-slate-300">Trip Plan Matches</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="notify_trip_matches" name="notify_trip_matches"
                                       {% if settings.notify_trip_matches is none or settings.notify_trip_matches %}checked{% endif %}
                                       class="sr-only peer">
                                <div class="w-9 h-5 bg-slate-300 dark:bg-slate-700 rounded-full peer peer-checked:bg-amber-500 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-4"></div>
                            </label>
                        </div>

                        <div class="flex items-center justify-between py-1">
                            <span class="text-sm text-slate-700 dark:text-slate-300">Route Price Updates</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="notify_route_updates" name="notify_route_updates"
                                       {% if settings.notify_route_updates is none or settings.notify_route_updates %}checked{% endif %}
                                       class="sr-only peer">
                                <div class="w-9 h-5 bg-slate-300 dark:bg-slate-700 rounded-full peer peer-checked:bg-amber-500 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-4"></div>
                            </label>
                        </div>

                        <div class="flex items-center justify-between py-1">
                            <span class="text-sm text-slate-700 dark:text-slate-300">System Alerts</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="notify_system" name="notify_system"
                                       {% if settings.notify_system is none or settings.notify_system %}checked{% endif %}
                                       class="sr-only peer">
                                <div class="w-9 h-5 bg-slate-300 dark:bg-slate-700 rounded-full peer peer-checked:bg-amber-500 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-4"></div>
                            </label>
                        </div>
                    </div>

                    <!-- Deal Quality Filter -->
                    <div class="border-t border-slate-200 dark:border-slate-700 pt-4">
                        <label for="deal_notify_min_rating" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Minimum Deal Rating</label>
                        <select id="deal_notify_min_rating" name="deal_notify_min_rating"
                                class="w-full sm:w-48 px-3 py-2.5 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-amber-500">
                            <option value="1" {% if settings.deal_notify_min_rating == 1 %}selected{% endif %}>1+ (All)</option>
                            <option value="2" {% if settings.deal_notify_min_rating == 2 %}selected{% endif %}>2+</option>
                            <option value="3" {% if (settings.deal_notify_min_rating or 3) == 3 %}selected{% endif %}>3+</option>
                            <option value="4" {% if settings.deal_notify_min_rating == 4 %}selected{% endif %}>4+</option>
                            <option value="5" {% if settings.deal_notify_min_rating == 5 %}selected{% endif %}>5 only</option>
                        </select>
                    </div>

                    <!-- Timing -->
                    <div class="border-t border-slate-200 dark:border-slate-700 pt-4 space-y-4">
                        <div>
                            <label for="timezone" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Timezone</label>
                            <select id="timezone" name="timezone"
                                    class="w-full sm:w-64 px-3 py-2.5 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-amber-500">
                                <option value="America/New_York" {% if (settings.timezone or 'America/New_York') == 'America/New_York' %}selected{% endif %}>America/New York</option>
                                <option value="America/Chicago" {% if settings.timezone == 'America/Chicago' %}selected{% endif %}>America/Chicago</option>
                                <option value="America/Denver" {% if settings.timezone == 'America/Denver' %}selected{% endif %}>America/Denver</option>
                                <option value="America/Los_Angeles" {% if settings.timezone == 'America/Los_Angeles' %}selected{% endif %}>America/Los Angeles</option>
                                <option value="Europe/London" {% if settings.timezone == 'Europe/London' %}selected{% endif %}>Europe/London</option>
                                <option value="Europe/Paris" {% if settings.timezone == 'Europe/Paris' %}selected{% endif %}>Europe/Paris</option>
                                <option value="Asia/Tokyo" {% if settings.timezone == 'Asia/Tokyo' %}selected{% endif %}>Asia/Tokyo</option>
                                <option value="Asia/Singapore" {% if settings.timezone == 'Asia/Singapore' %}selected{% endif %}>Asia/Singapore</option>
                                <option value="Australia/Sydney" {% if settings.timezone == 'Australia/Sydney' %}selected{% endif %}>Australia/Sydney</option>
                                <option value="Pacific/Auckland" {% if settings.timezone == 'Pacific/Auckland' %}selected{% endif %}>Pacific/Auckland</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Quiet Hours</label>
                            <div class="flex items-center gap-2 flex-wrap">
                                <select id="notification_quiet_hours_start" name="notification_quiet_hours_start"
                                        class="px-3 py-2.5 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-amber-500">
                                    <option value="">Off</option>
                                    {% for h in range(24) %}
                                    <option value="{{ h }}" {% if settings.notification_quiet_hours_start == h %}selected{% endif %}>{{ '%02d:00'|format(h) }}</option>
                                    {% endfor %}
                                </select>
                                <span class="text-slate-500 text-sm">to</span>
                                <select id="notification_quiet_hours_end" name="notification_quiet_hours_end"
                                        class="px-3 py-2.5 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-amber-500">
                                    <option value="">Off</option>
                                    {% for h in range(24) %}
                                    <option value="{{ h }}" {% if settings.notification_quiet_hours_end == h %}selected{% endif %}>{{ '%02d:00'|format(h) }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div>
                            <label for="notification_cooldown_minutes" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Cooldown (same route)</label>
                            <select id="notification_cooldown_minutes" name="notification_cooldown_minutes"
                                    class="w-full sm:w-40 px-3 py-2.5 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-amber-500">
                                <option value="30" {% if (settings.notification_cooldown_minutes or 60) == 30 %}selected{% endif %}>30 min</option>
                                <option value="60" {% if (settings.notification_cooldown_minutes or 60) == 60 %}selected{% endif %}>1 hour</option>
                                <option value="120" {% if settings.notification_cooldown_minutes == 120 %}selected{% endif %}>2 hours</option>
                                <option value="360" {% if settings.notification_cooldown_minutes == 360 %}selected{% endif %}>6 hours</option>
                                <option value="1440" {% if settings.notification_cooldown_minutes == 1440 %}selected{% endif %}>24 hours</option>
                            </select>
                        </div>
                    </div>
                </div>
            </details>

            <!-- AI & APIs (Collapsible) -->
            <details class="group bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                <summary class="flex items-center justify-between p-4 cursor-pointer select-none hover:bg-slate-50 dark:hover:bg-slate-700/50 rounded-xl transition-colors">
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-lg bg-purple-500/10 flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                            </svg>
                        </div>
                        <div>
                            <h2 class="font-semibold text-slate-900 dark:text-white">AI & API Keys</h2>
                            <p class="text-xs text-slate-500 dark:text-slate-400">Optional integrations</p>
                        </div>
                    </div>
                    <svg class="w-5 h-5 text-slate-400 group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </summary>
                <div class="px-4 pb-4 pt-2 space-y-5 border-t border-slate-200 dark:border-slate-700">
                    <!-- AI Provider -->
                    <div>
                        <label for="ai_provider" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">AI Provider</label>
                        <select id="ai_provider" name="ai_provider" onchange="toggleAIFields()"
                                class="w-full px-3 py-2.5 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="none" {% if not settings.ai_provider or settings.ai_provider == 'none' %}selected{% endif %}>None (Basic mode)</option>
                            <option value="anthropic" {% if settings.ai_provider == 'anthropic' %}selected{% endif %}>Anthropic (Claude)</option>
                            <option value="openai" {% if settings.ai_provider == 'openai' %}selected{% endif %}>OpenAI (GPT)</option>
                            <option value="gemini" {% if settings.ai_provider == 'gemini' %}selected{% endif %}>Google (Gemini)</option>
                            <option value="ollama" {% if settings.ai_provider == 'ollama' %}selected{% endif %}>Ollama (Local)</option>
                            <option value="openai_compatible" {% if settings.ai_provider == 'openai_compatible' %}selected{% endif %}>OpenAI-Compatible</option>
                        </select>
                        <p class="mt-1 text-xs text-slate-500">AI helps accurately parse deal routes</p>
                    </div>

                    <div id="ai_api_key_field" class="hidden">
                        <label for="ai_api_key" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">API Key</label>
                        <input type="password" id="ai_api_key" name="ai_api_key" value="{{ settings.ai_api_key or '' }}"
                               class="w-full px-3 py-2.5 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm font-mono focus:outline-none focus:ring-2 focus:ring-purple-500"
                               placeholder="Your API key">
                        <p id="ai_key_help" class="mt-1 text-xs text-slate-500"></p>
                    </div>

                    <div id="ai_ollama_url_field" class="hidden">
                        <label for="ai_ollama_url" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Base URL</label>
                        <input type="text" id="ai_ollama_url" name="ai_ollama_url" value="{{ settings.ai_ollama_url or '' }}"
                               class="w-full px-3 py-2.5 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm font-mono focus:outline-none focus:ring-2 focus:ring-purple-500"
                               placeholder="http://localhost:11434">
                    </div>

                    <div id="ai_model_field" class="hidden">
                        <label for="ai_model" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Model <span class="text-slate-400 font-normal">(optional)</span></label>
                        <input type="text" id="ai_model" name="ai_model" value="{{ settings.ai_model or '' }}"
                               class="w-full px-3 py-2.5 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm font-mono focus:outline-none focus:ring-2 focus:ring-purple-500"
                               placeholder="Uses default if empty">
                        <p id="ai_model_help" class="mt-1 text-xs text-slate-500"></p>
                    </div>

                    <!-- Other API Keys -->
                    <div class="border-t border-slate-200 dark:border-slate-700 pt-4 space-y-4">
                        <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">Data Sources</p>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Anthropic API Key</label>
                            <input type="password" id="anthropic_api_key" name="anthropic_api_key" value="{{ settings.anthropic_api_key or '' }}"
                                   class="w-full px-3 py-2.5 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm font-mono focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                   placeholder="sk-ant-...">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">SerpAPI Key <span class="text-emerald-500 text-xs">(Google Flights)</span></label>
                            <input type="password" id="serpapi_key" name="serpapi_key" value="{{ settings.serpapi_key or '' }}"
                                   class="w-full px-3 py-2.5 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm font-mono focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                   placeholder="your-serpapi-key">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Skyscanner RapidAPI Key</label>
                            <input type="password" id="skyscanner_api_key" name="skyscanner_api_key" value="{{ settings.skyscanner_api_key or '' }}"
                                   class="w-full px-3 py-2.5 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm font-mono focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                   placeholder="your-rapidapi-key">
                        </div>
                    </div>
                </div>
            </details>

            <!-- Save Button - Sticky on mobile -->
            <div class="sticky bottom-0 bg-slate-100 dark:bg-slate-900 py-4 -mx-4 px-4 sm:relative sm:bg-transparent sm:py-0 sm:mx-0 sm:px-0 border-t border-slate-200 dark:border-slate-800 sm:border-0">
                <div class="flex items-center justify-between gap-4">
                    <a href="/deals/" class="text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors flex items-center gap-1 text-sm">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                        Back
                    </a>
                    <button type="submit"
                            class="flex-1 sm:flex-none px-6 py-2.5 bg-cyan-500 hover:bg-cyan-400 text-white font-semibold rounded-lg shadow-lg shadow-cyan-500/25 transition-all flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        Save Settings
                    </button>
                </div>
            </div>
        </form>

        <div id="save-status" class="hidden mt-4 p-3 rounded-lg text-center text-sm"></div>
    </div>
</div>

<script>
const airportNames = {
    'SYD': 'Sydney', 'MEL': 'Melbourne', 'AKL': 'Auckland', 'CHC': 'Christchurch',
    'NAN': 'Nadi', 'HNL': 'Honolulu', 'SIN': 'Singapore', 'BNE': 'Brisbane',
    'TYO': 'Tokyo', 'NRT': 'Tokyo Narita', 'HND': 'Tokyo Haneda',
    'LHR': 'London Heathrow', 'LAX': 'Los Angeles', 'JFK': 'New York JFK',
    'DXB': 'Dubai', 'BKK': 'Bangkok', 'DPS': 'Bali', 'RAR': 'Rarotonga'
};

const aiProviderConfig = {
    'none': { showKey: false, showUrl: false, showModel: false },
    'anthropic': { showKey: true, showUrl: false, showModel: true, keyHelp: 'console.anthropic.com', modelHelp: 'Default: claude-3-haiku' },
    'openai': { showKey: true, showUrl: false, showModel: true, keyHelp: 'platform.openai.com', modelHelp: 'Default: gpt-4o-mini' },
    'gemini': { showKey: true, showUrl: false, showModel: true, keyHelp: 'aistudio.google.com', modelHelp: 'Default: gemini-1.5-flash' },
    'ollama': { showKey: false, showUrl: true, showModel: true, modelHelp: 'Default: llama3.2' },
    'openai_compatible': { showKey: true, showUrl: true, showModel: true, keyHelp: 'Your provider', modelHelp: 'Required' },
};

function toggleAIFields() {
    const provider = document.getElementById('ai_provider').value;
    const config = aiProviderConfig[provider] || aiProviderConfig['none'];
    document.getElementById('ai_api_key_field').classList.toggle('hidden', !config.showKey);
    document.getElementById('ai_ollama_url_field').classList.toggle('hidden', !config.showUrl);
    document.getElementById('ai_model_field').classList.toggle('hidden', !config.showModel);
    if (config.keyHelp) document.getElementById('ai_key_help').textContent = config.keyHelp;
    if (config.modelHelp) document.getElementById('ai_model_help').textContent = config.modelHelp;
}

function toggleNotificationFields() {
    const provider = document.getElementById('notification_provider').value;
    document.getElementById('ntfy_sh_fields').classList.toggle('hidden', provider !== 'ntfy_sh');
    document.getElementById('ntfy_self_fields').classList.toggle('hidden', provider !== 'ntfy_self');
    document.getElementById('discord_fields').classList.toggle('hidden', provider !== 'discord');
}

document.addEventListener('DOMContentLoaded', function() {
    toggleAIFields();
    toggleNotificationFields();
});

// Test Notification
document.getElementById('test-notification-btn').addEventListener('click', async function() {
    const btn = this;
    const status = document.getElementById('test-notification-status');
    btn.disabled = true;
    btn.textContent = 'Sending...';
    try {
        const response = await fetch('/api/notifications/test', { method: 'POST' });
        const data = await response.json();
        status.className = data.success ? 'text-sm text-emerald-500' : 'text-sm text-amber-500';
        status.textContent = data.success ? 'Sent!' : 'Check config';
    } catch (err) {
        status.className = 'text-sm text-red-500';
        status.textContent = 'Failed';
    } finally {
        btn.disabled = false;
        btn.textContent = 'Send Test';
        setTimeout(() => { status.textContent = ''; }, 3000);
    }
});

// Home Airports
const homeInput = document.getElementById('home_airport_search');
const homeDropdown = document.getElementById('home-airport-dropdown');
const homeContainer = document.getElementById('home-airports-container');
const homeHidden = document.getElementById('home_airports');
const homeLegacyHidden = document.getElementById('home_airport');

let selectedHomeAirports = homeHidden.value.split(',').map(s => s.trim()).filter(s => s).map(code => ({ code, name: airportNames[code] || code }));
renderHomeAirports();

let homeDebounceTimer;
homeInput.addEventListener('input', (e) => {
    clearTimeout(homeDebounceTimer);
    const query = e.target.value.trim();
    if (query.length < 2) { homeDropdown.classList.add('hidden'); return; }
    homeDebounceTimer = setTimeout(async () => {
        try {
            const response = await fetch('/settings/api/airports/search?q=' + encodeURIComponent(query) + '&limit=6');
            const data = await response.json();
            if (data.results && data.results.length > 0) {
                const available = data.results.filter(r => !selectedHomeAirports.find(s => s.code === r.code));
                if (available.length === 0) {
                    homeDropdown.textContent = '';
                    const div = document.createElement('div');
                    div.className = 'px-3 py-2 text-sm text-slate-500 italic';
                    div.textContent = 'Already added';
                    homeDropdown.appendChild(div);
                } else {
                    homeDropdown.textContent = '';
                    available.forEach(a => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'w-full px-3 py-2 text-left hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center justify-between text-sm';
                        const span1 = document.createElement('span');
                        span1.className = 'font-medium';
                        span1.textContent = a.city;
                        const span2 = document.createElement('span');
                        span2.className = 'font-mono text-slate-500';
                        span2.textContent = a.code;
                        btn.appendChild(span1);
                        btn.appendChild(span2);
                        btn.addEventListener('click', () => addHomeAirport(a.code, a.city));
                        homeDropdown.appendChild(btn);
                    });
                }
                homeDropdown.classList.remove('hidden');
            } else {
                homeDropdown.textContent = '';
                const div = document.createElement('div');
                div.className = 'px-3 py-2 text-sm text-slate-500';
                div.textContent = 'No results';
                homeDropdown.appendChild(div);
                homeDropdown.classList.remove('hidden');
            }
        } catch (err) { console.error(err); }
    }, 200);
});

function addHomeAirport(code, city) {
    if (selectedHomeAirports.some(d => d.code === code)) return;
    selectedHomeAirports.push({ code, name: city });
    updateHomeAirports();
    homeInput.value = '';
    homeDropdown.classList.add('hidden');
}

function removeHomeAirport(code) {
    selectedHomeAirports = selectedHomeAirports.filter(d => d.code !== code);
    updateHomeAirports();
}

function updateHomeAirports() {
    homeHidden.value = selectedHomeAirports.map(d => d.code).join(',');
    homeLegacyHidden.value = selectedHomeAirports.length > 0 ? selectedHomeAirports[0].code : '';
    renderHomeAirports();
}

function renderHomeAirports() {
    homeContainer.textContent = '';
    selectedHomeAirports.forEach(dest => {
        const span = document.createElement('span');
        span.className = 'inline-flex items-center gap-1 pl-2 pr-1 py-1 rounded-md bg-slate-100 dark:bg-slate-700 text-sm';
        const codeSpan = document.createElement('span');
        codeSpan.className = 'font-mono text-cyan-600 dark:text-cyan-400 font-bold';
        codeSpan.textContent = dest.code;
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'p-0.5 hover:text-red-500';
        btn.innerHTML = '<svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
        btn.addEventListener('click', () => removeHomeAirport(dest.code));
        span.appendChild(codeSpan);
        span.appendChild(btn);
        homeContainer.appendChild(span);
    });
}

// Destinations
const destInput = document.getElementById('destination_search');
const destDropdown = document.getElementById('destination-dropdown');
const destContainer = document.getElementById('destinations-container');
const destHidden = document.getElementById('watched_destinations');

let selectedDestinations = destHidden.value.split(',').map(s => s.trim()).filter(s => s).map(code => ({ code, name: airportNames[code] || code }));
renderDestinations();

let destDebounceTimer;
destInput.addEventListener('input', (e) => {
    clearTimeout(destDebounceTimer);
    const query = e.target.value.trim();
    if (query.length < 2) { destDropdown.classList.add('hidden'); return; }
    destDebounceTimer = setTimeout(async () => {
        try {
            const response = await fetch('/settings/api/airports/search?q=' + encodeURIComponent(query) + '&limit=6');
            const data = await response.json();
            if (data.results && data.results.length > 0) {
                const available = data.results.filter(r => !selectedDestinations.find(s => s.code === r.code));
                if (available.length === 0) {
                    destDropdown.textContent = '';
                    const div = document.createElement('div');
                    div.className = 'px-3 py-2 text-sm text-slate-500 italic';
                    div.textContent = 'Already added';
                    destDropdown.appendChild(div);
                } else {
                    destDropdown.textContent = '';
                    available.forEach(a => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'w-full px-3 py-2 text-left hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center justify-between text-sm';
                        const span1 = document.createElement('span');
                        span1.className = 'font-medium';
                        span1.textContent = a.city;
                        const span2 = document.createElement('span');
                        span2.className = 'font-mono text-slate-500';
                        span2.textContent = a.code;
                        btn.appendChild(span1);
                        btn.appendChild(span2);
                        btn.addEventListener('click', () => addDestination(a.code, a.city));
                        destDropdown.appendChild(btn);
                    });
                }
                destDropdown.classList.remove('hidden');
            } else {
                destDropdown.textContent = '';
                const div = document.createElement('div');
                div.className = 'px-3 py-2 text-sm text-slate-500';
                div.textContent = 'No results';
                destDropdown.appendChild(div);
                destDropdown.classList.remove('hidden');
            }
        } catch (err) { console.error(err); }
    }, 200);
});

function addDestination(code, city) {
    if (selectedDestinations.some(d => d.code === code)) return;
    selectedDestinations.push({ code, name: city });
    updateDestinations();
    destInput.value = '';
    destDropdown.classList.add('hidden');
}

function removeDestination(code) {
    selectedDestinations = selectedDestinations.filter(d => d.code !== code);
    updateDestinations();
}

function updateDestinations() {
    destHidden.value = selectedDestinations.map(d => d.code).join(',');
    renderDestinations();
}

function renderDestinations() {
    destContainer.textContent = '';
    selectedDestinations.forEach(dest => {
        const span = document.createElement('span');
        span.className = 'inline-flex items-center gap-1 pl-2 pr-1 py-1 rounded-md bg-slate-100 dark:bg-slate-700 text-sm';
        const codeSpan = document.createElement('span');
        codeSpan.className = 'font-mono text-cyan-600 dark:text-cyan-400 font-bold';
        codeSpan.textContent = dest.code;
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'p-0.5 hover:text-red-500';
        btn.innerHTML = '<svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
        btn.addEventListener('click', () => removeDestination(dest.code));
        span.appendChild(codeSpan);
        span.appendChild(btn);
        destContainer.appendChild(span);
    });
}

// Close dropdowns on outside click
document.addEventListener('click', (e) => {
    if (!homeInput.contains(e.target) && !homeDropdown.contains(e.target)) homeDropdown.classList.add('hidden');
    if (!destInput.contains(e.target) && !destDropdown.contains(e.target)) destDropdown.classList.add('hidden');
});

// Form Submit
document.getElementById('settings-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const statusEl = document.getElementById('save-status');
    const submitBtn = form.querySelector('button[type="submit"]');

    submitBtn.disabled = true;
    const origHTML = submitBtn.innerHTML;
    submitBtn.innerHTML = '<svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg> Saving...';

    const watchedDests = form.watched_destinations.value.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
    const homeAirports = form.home_airports.value.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
    const primaryHomeAirport = homeAirports.length > 0 ? homeAirports[0] : '';
    const quietStart = form.notification_quiet_hours_start.value;
    const quietEnd = form.notification_quiet_hours_end.value;

    const notifProvider = form.notification_provider.value;
    let ntfyTopic = null;
    if (notifProvider === 'ntfy_sh') ntfyTopic = document.getElementById('notification_ntfy_topic_sh').value || null;
    else if (notifProvider === 'ntfy_self') ntfyTopic = document.getElementById('notification_ntfy_topic_self').value || null;

    const data = {
        home_airport: primaryHomeAirport,
        home_airports: homeAirports,
        home_region: form.home_region.value,
        watched_destinations: watchedDests,
        preferred_currency: form.preferred_currency.value,
        notifications_enabled: form.notifications_enabled.checked,
        notification_provider: notifProvider,
        notification_ntfy_url: form.notification_ntfy_url ? form.notification_ntfy_url.value : null,
        notification_ntfy_topic: ntfyTopic,
        notification_discord_webhook: form.notification_discord_webhook ? form.notification_discord_webhook.value : null,
        notification_quiet_hours_start: quietStart ? parseInt(quietStart) : null,
        notification_quiet_hours_end: quietEnd ? parseInt(quietEnd) : null,
        notification_cooldown_minutes: parseInt(form.notification_cooldown_minutes.value) || 60,
        timezone: form.timezone.value,
        notify_deals: form.notify_deals ? form.notify_deals.checked : true,
        notify_trip_matches: form.notify_trip_matches ? form.notify_trip_matches.checked : true,
        notify_route_updates: form.notify_route_updates ? form.notify_route_updates.checked : true,
        notify_system: form.notify_system ? form.notify_system.checked : true,
        deal_notify_min_rating: parseInt(form.deal_notify_min_rating ? form.deal_notify_min_rating.value : 3) || 3,
        anthropic_api_key: form.anthropic_api_key.value,
        serpapi_key: form.serpapi_key.value,
        skyscanner_api_key: form.skyscanner_api_key.value,
        ai_provider: form.ai_provider.value,
        ai_api_key: form.ai_api_key.value,
        ai_ollama_url: form.ai_ollama_url.value,
        ai_model: form.ai_model.value,
    };

    try {
        const response = await fetch('/settings/api/settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        });
        if (response.ok) {
            statusEl.className = 'mt-4 p-3 rounded-lg text-center text-sm bg-emerald-500/10 text-emerald-500 border border-emerald-500/20';
            statusEl.textContent = 'Settings saved!';
            statusEl.classList.remove('hidden');
            setTimeout(() => statusEl.classList.add('hidden'), 3000);
        } else { throw new Error('Failed'); }
    } catch (err) {
        statusEl.className = 'mt-4 p-3 rounded-lg text-center text-sm bg-red-500/10 text-red-500 border border-red-500/20';
        statusEl.textContent = 'Failed to save. Please try again.';
        statusEl.classList.remove('hidden');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = origHTML;
    }
});
</script>
{% endblock %}
