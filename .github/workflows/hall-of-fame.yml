name: Hall of Fame

on:
  pull_request:
    types: [closed]

jobs:
  celebrate:
    if: github.event.pull_request.merged == true && github.event.pull_request.user.login != 'jesposito'
    runs-on: ubuntu-latest
    steps:
      - name: Celebrate new contributor
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_HALL_OF_FAME_WEBHOOK }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_AVATAR: ${{ github.event.pull_request.user.avatar_url }}
          REPO_NAME: ${{ github.event.repository.name }}
          REPO_FULL: ${{ github.repository }}
        run: |
          CONTRIB_COUNT=$(curl -s "https://api.github.com/repos/${REPO_FULL}/commits?author=${PR_AUTHOR}&per_page=5" | jq length)
          
          if [ "$CONTRIB_COUNT" -le 1 ]; then
            TITLE="NEW CONTRIBUTOR ALERT!"
            DESCRIPTION="Welcome to the family!"
            COLOR=16766720
          else
            TITLE="Contribution Merged!"
            DESCRIPTION="Thanks for the continued support!"
            COLOR=5814783
          fi
          
          jq -n \
            --arg title "$TITLE" \
            --arg author "$PR_AUTHOR" \
            --arg repo "$REPO_NAME" \
            --arg desc "$DESCRIPTION" \
            --arg pr_title "$PR_TITLE" \
            --arg pr_url "$PR_URL" \
            --arg avatar "$PR_AVATAR" \
            --argjson color "$COLOR" \
            '{
              "embeds": [{
                "title": $title,
                "description": ("**" + $author + "** just contributed to **" + $repo + "**!\n\n" + $desc),
                "color": $color,
                "fields": [{
                  "name": "Pull Request",
                  "value": ("[" + $pr_title + "](" + $pr_url + ")"),
                  "inline": false
                }],
                "thumbnail": {"url": $avatar},
                "footer": {"text": "Want to be featured? Contribute to our projects!"}
              }]
            }' > payload.json
          
          curl -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d @payload.json

  update-hall-of-fame:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    needs: celebrate
    continue-on-error: true
    steps:
      - name: Trigger Hall of Fame update
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_HALL_OF_FAME_WEBHOOK }}
        run: |
          curl -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d '{"content": "Hall of Fame stats updating..."}'
