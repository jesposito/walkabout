name: Hall of Fame

on:
  pull_request:
    types: [closed]

jobs:
  celebrate:
    if: github.event.pull_request.merged == true && github.event.pull_request.user.login != 'jesposito'
    runs-on: ubuntu-latest
    steps:
      - name: Celebrate new contributor
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_HALL_OF_FAME_WEBHOOK }}
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_AVATAR="${{ github.event.pull_request.user.avatar_url }}"
          REPO_NAME="${{ github.event.repository.name }}"
          
          CONTRIB_COUNT=$(curl -s "https://api.github.com/repos/${{ github.repository }}/commits?author=${PR_AUTHOR}" | jq length)
          
          if [ "$CONTRIB_COUNT" -le 1 ]; then
            TITLE="ðŸŽ‰ NEW CONTRIBUTOR ALERT!"
            DESCRIPTION="Welcome to the family!"
            COLOR=16766720
          else
            TITLE="ðŸš€ Contribution Merged!"
            DESCRIPTION="Thanks for the continued support!"
            COLOR=5814783
          fi
          
          curl -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"$TITLE\",
                \"description\": \"**${PR_AUTHOR}** just contributed to **${REPO_NAME}**!\n\n$DESCRIPTION\",
                \"color\": $COLOR,
                \"fields\": [
                  {
                    \"name\": \"Pull Request\",
                    \"value\": \"[${PR_TITLE}](${PR_URL})\",
                    \"inline\": false
                  }
                ],
                \"thumbnail\": {
                  \"url\": \"${PR_AVATAR}\"
                },
                \"footer\": {
                  \"text\": \"Want to be featured? Contribute to our projects!\"
                }
              }]
            }"

  update-hall-of-fame:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    needs: celebrate
    continue-on-error: true
    steps:
      - name: Trigger Hall of Fame update
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_HALL_OF_FAME_WEBHOOK }}
        run: |
          curl -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "{
              \"content\": \"ðŸ“Š *Hall of Fame stats updating...*\"
            }"
